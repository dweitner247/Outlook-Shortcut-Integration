<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Shortcut Add-in</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script>
    Office.onReady(() => {
      console.log("Office ist bereit – Add-in geladen.");
    });

    async function createShortcutStory(event) {
      try {
        const item = Office.context.mailbox.item;

        // Betreff und Body der Mail auslesen
        const subject = item.subject;
        const body = await getBodyAsync(item);

        // Shortcut API-Daten
        const shortcutToken = "b7a73287-ee90-4e31-9958-785a9ceeba52"; 
        const teamId = "68d27e9b-e00a-49a3-b440-e28b1cb7caa3";              // ⚠️ Prüfe in Shortcut: ID ist meistens eine Zahl
        const workflowStateId = "500000006";                                // ⚠️ muss zu deinem Workflow passen

        // Payload vorbereiten
        const payload = {
          name: subject || "(Kein Betreff)",
          description: body || "(Kein Inhalt)",
          team_id: teamId,
          workflow_state_id: workflowStateId
        };

        // Debug-Logs
        console.log("Shortcut Payload:", payload);

        // HTTP-Request über Outlook API
        Office.context.httpRequestAsync(
          {
            url: "https://api.app.shortcut.com/api/v3/stories",
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Shortcut-Token": shortcutToken
            },
            body: JSON.stringify(payload)
          },
          function (result) {
            console.log("Shortcut Status:", result.status);
            console.log("Shortcut Antwort:", result.responseText);

            if (result.status === 200) {
              Office.context.mailbox.item.notificationMessages.replaceAsync("status", {
                type: "informationalMessage",
                message: "Story wurde erfolgreich in Shortcut erstellt.",
                icon: "icon16",
                persistent: false
              });
            } else {
              Office.context.mailbox.item.notificationMessages.replaceAsync("status", {
                type: "errorMessage",
                message: `Fehler: ${result.status} - ${result.responseText}`,
                persistent: false
              });
            }
            event.completed();
          }
        );

      } catch (error) {
        console.error("Fehler im Add-in:", error);
        Office.context.mailbox.item.notificationMessages.replaceAsync("status", {
          type: "errorMessage",
          message: `Fehler beim Erstellen: ${error.message}`,
          persistent: false
        });
        event.completed();
      }
    }

    // Hilfsfunktion: E-Mail-Body abrufen
    function getBodyAsync(item) {
      return new Promise((resolve, reject) => {
        item.body.getAsync("text", result => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            resolve(result.value);
          } else {
            reject(result.error);
          }
        });
      });
    }

    // Für Manifest
    window.createShortcutStory = createShortcutStory;
  </script>
</head>
<body>
  <h1>Shortcut Integration läuft!(Debug-Modus)</h1>
</body>
</html>











