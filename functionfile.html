<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Shortcut Add-in</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script>
    Office.onReady(() => {
      console.log("Office ist bereit â€“ Add-in geladen.");
    });

    async function createShortcutStory(event) {
      try {
        const item = Office.context.mailbox.item;

        // Betreff und Body der Mail
        const subject = item.subject || "(Ohne Betreff)";
        const body = await getBodyAsync(item);

        // Payload fÃ¼r den Proxy
        const payload = {
          name: subject,
          description: body
        };

        console.log("Sende Payload an Proxy:", payload);

        // Request an deinen Proxy
        const response = await fetch("http://localhost:3000/shortcut", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        console.log("Antwort vom Proxy:", result);

        if (response.ok) {
          const storyUrl = result.app_url;
          console.log("ðŸ”— Story-URL:", storyUrl);

          // âœ… Erfolgsmeldung in Outlook-Leiste
          Office.context.mailbox.item.notificationMessages.replaceAsync("status", {
            type: "informationalMessage",
            message: "âœ… Story wurde erfolgreich in Shortcut erstellt.",
            icon: "icon16",
            persistent: false
          });

          // ðŸªŸ Dialog-Fenster mit klickbarem Link Ã¶ffnen
          if (storyUrl) {
            setTimeout(() => {
              const dialogUrl = `https://dweitner247.github.io/Outlook-Shortcut-Integration/dialog.html?url=${encodeURIComponent(storyUrl)}`;
              Office.context.ui.displayDialogAsync(
                dialogUrl,
                { height: 40, width: 40, displayInIframe: true },
                result => console.log("Dialog geÃ¶ffnet:", result.status)
              );
            }, 1000); // kleine VerzÃ¶gerung fÃ¼r bessere Nutzererfahrung
          }

        } else {
          throw new Error(`Fehler: ${response.status} - ${JSON.stringify(result)}`);
        }

      } catch (error) {
        console.error("Fehler beim Erstellen:", error);
        Office.context.mailbox.item.notificationMessages.replaceAsync("status", {
          type: "errorMessage",
          message: `Fehler: ${error.message}`,
          persistent: false
        });
      } finally {
        event.completed();
      }
    }

    // Hilfsfunktion: Body auslesen
    function getBodyAsync(item) {
      return new Promise((resolve, reject) => {
        item.body.getAsync("text", result => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            resolve(result.value);
          } else {
            reject(result.error);
          }
        });
      });
    }

    // Funktion global registrieren
    window.createShortcutStory = createShortcutStory;
  </script>
</head>
<body>
  <h1>Shortcut Integration</h1>
</body>
</html>













