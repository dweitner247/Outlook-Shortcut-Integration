<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Shortcut Add-in</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script>
    Office.onReady(() => {
      console.log("Office ist bereit â€“ Add-in geladen.");
    });

    async function createShortcutStory(event) {
      try {
        const item = Office.context.mailbox.item;

        // Betreff und Body der Mail
        const subject = item.subject || "(Ohne Betreff)";
        const body = await getBodyAsync(item);

        // Payload fÃ¼r den Proxy (der hÃ¤ngt workflow_state_id automatisch dran)
        const payload = {
          name: subject,
          description: body
        };

        console.log("Sende Payload an Proxy:", payload);

        // Request an deinen Proxy
        const response = await fetch("http://localhost:3000/shortcut", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        console.log("Antwort vom Proxy:", result);

        if (response.ok) {
          const storyUrl = result.app_url;
          console.log("ðŸ”— Story-URL:", storyUrl);

          // âœ… Erfolgsmeldung
          Office.context.mailbox.item.notificationMessages.replaceAsync("status1", {
            type: "informationalMessage",
            message: "âœ… Story wurde erfolgreich in Shortcut erstellt.",
            icon: "icon16",
            persistent: false
          });

          // ðŸ”— Zweite Meldung (mit Ã–ffnen-Funktion)
          if (storyUrl) {
            Office.context.mailbox.item.notificationMessages.replaceAsync("status2", {
              type: "informationalMessage",
              message: "ðŸ”— Story-Link Ã¶ffnen (hier klicken!)",
              icon: "icon16",
              persistent: false,
              actions: [{
                actionType: "openUrl",
                actionText: "Story Ã¶ffnen",
                commandId: storyUrl
              }]
            });
          }

        } else {
          throw new Error(`Fehler: ${response.status} - ${JSON.stringify(result)}`);
        }

      } catch (error) {
        console.error("Fehler beim Erstellen:", error);
        Office.context.mailbox.item.notificationMessages.replaceAsync("status", {
          type: "errorMessage",
          message: `Fehler: ${error.message}`,
          persistent: false
        });
      } finally {
        event.completed();
      }
    }

    // Hilfsfunktion: Body auslesen
    function getBodyAsync(item) {
      return new Promise((resolve, reject) => {
        item.body.getAsync("text", result => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            resolve(result.value);
          } else {
            reject(result.error);
          }
        });
      });
    }

    // Funktion global registrieren
    window.createShortcutStory = createShortcutStory;
  </script>
</head>
<body>
  <h1>Shortcut Integration</h1>
</body>
</html>










